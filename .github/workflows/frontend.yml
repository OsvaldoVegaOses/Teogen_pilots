# TheoGen Frontend Deployment Workflow
name: Deploy Frontend

on:
  push:
    branches: [ "main" ]
    paths:
      - 'frontend/**'
  workflow_dispatch:

permissions:
  contents: read

env:
  AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
  AZURE_RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
  NEXT_PUBLIC_AZURE_AD_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_AZURE_AD_CLIENT_ID }}
  NEXT_PUBLIC_AZURE_AD_TENANT_ID: ${{ secrets.NEXT_PUBLIC_AZURE_AD_TENANT_ID }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install Dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Build
      working-directory: ./frontend
      run: npm run build
      env:
        # Inject environment variables needed at build time
        NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
        NEXT_PUBLIC_AZURE_AD_CLIENT_ID: ${{ env.NEXT_PUBLIC_AZURE_AD_CLIENT_ID }}
        NEXT_PUBLIC_AZURE_AD_TENANT_ID: ${{ env.NEXT_PUBLIC_AZURE_AD_TENANT_ID }}

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Upload to Blob Storage
      uses: azure/CLI@v2
      with:
        inlineScript: |
          az storage blob upload-batch \
            --account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
            --auth-mode login \
            --destination '$web' \
            --source frontend/out \
            --overwrite

    - name: Purge CDN (Optional)
      # Uncomment if you use Azure CDN
      # run: az cdn endpoint purge --resource-group ... --profile-name ... --name ... --content-paths "/*"
      run: echo "Skipping CDN purge"
